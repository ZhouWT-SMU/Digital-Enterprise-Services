<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>企业信息采集与匹配</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div id="app" class="layout" v-cloak>
    <aside class="sidebar">
      <h1 class="sidebar__title">企业服务台</h1>
      <nav class="sidebar__nav">
        <button :class="['nav__item', { 'nav__item--active': currentView === 'onboard' }]" @click="currentView = 'onboard'">
          企业信息录入
        </button>
        <button :class="['nav__item', { 'nav__item--active': currentView === 'match' }]" @click="currentView = 'match'">
          企业匹配问答
        </button>
        <div class="sidebar__hint">
          提示：若后端部署在其他域名，可在加载页面前设置 <code>window.API_BASE</code>。
        </div>
      </nav>
    </aside>

    <main class="content">
      <section v-if="currentView === 'onboard'" class="panel">
        <header class="panel__header">
          <h2>企业信息录入</h2>
          <p>填写企业基础信息、业务画像与联系人，并上传相关文件。</p>
          <div class="panel__hint">
            字段会在后端自动转换为 Dify Workflow 支持的文本、段落、下拉、复选框与文件类型，无需手动拼接 JSON。
          </div>
        </header>

        <form class="form" @submit.prevent="submitCompany">
          <h3 class="form__section">一、企业基础信息</h3>
          <div class="form__grid">
            <label>企业名称
              <input type="text" v-model="companyForm.name" required />
            </label>
            <label>统一社会信用代码
              <input type="text" v-model="companyForm.unifiedSocialCreditCode" required />
            </label>
            <label>成立日期
              <input type="date" v-model="companyForm.establishmentDate" required />
            </label>
            <label>企业规模
              <select v-model="companyForm.scale" required>
                <option disabled value="">请选择</option>
                <option value="1-49">1-49</option>
                <option value="50-149">50-149</option>
                <option value="150-499">150-499</option>
                <option value="500+">500+</option>
              </select>
            </label>
            <label>所属行业（用逗号分隔）
              <input type="text" v-model="companyForm.industriesText" placeholder="软件服务, 制造业" />
            </label>
            <label>企业类型
              <select v-model="companyForm.companyType" required>
                <option disabled value="">请选择</option>
                <option value="民营">民营</option>
                <option value="国企">国企</option>
                <option value="外资">外资</option>
                <option value="合资">合资</option>
                <option value="事业单位">事业单位</option>
                <option value="其他">其他</option>
              </select>
            </label>
          </div>

          <div class="form__grid form__grid--address">
            <label>国家
              <input type="text" v-model="companyForm.address.country" />
            </label>
            <label>省份
              <input type="text" v-model="companyForm.address.province" />
            </label>
            <label>城市
              <input type="text" v-model="companyForm.address.city" />
            </label>
            <label>区/县
              <input type="text" v-model="companyForm.address.district" />
            </label>
            <label class="form__full">详细地址
              <input type="text" v-model="companyForm.address.streetAddress" />
            </label>
          </div>

          <label class="form__full">业务简介（500-1500 字）
            <textarea v-model="companyForm.businessOverview" rows="6" placeholder="介绍企业核心业务、客户案例等"></textarea>
          </label>

          <div class="form__files">
            <label>营业执照文件
              <input type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" @change="handleBusinessLicenseUpload" />
            </label>
            <span v-if="businessLicenseFileId">已上传：{{ businessLicenseFileName }}</span>
          </div>

          <h3 class="form__section">二、核心产品 / 服务</h3>
          <div v-for="(offering, index) in companyForm.coreOfferings" :key="index" class="card">
            <div class="card__header">
              <span>条目 {{ index + 1 }}</span>
              <button type="button" class="link" @click="removeCoreOffering(index)" v-if="companyForm.coreOfferings.length > 1">删除</button>
            </div>
            <label>名称
              <input type="text" v-model="offering.name" />
            </label>
            <label>类型
              <select v-model="offering.type">
                <option value="产品">产品</option>
                <option value="服务">服务</option>
                <option value="方案">方案</option>
              </select>
            </label>
            <label>产品简述
              <textarea v-model="offering.description" rows="3"></textarea>
            </label>
          </div>
          <button type="button" class="button button--ghost" @click="addCoreOffering">+ 新增产品 / 服务</button>

          <h3 class="form__section">三、技术栈与知识产权</h3>
          <label class="form__full">技术栈（用逗号分隔）
            <input type="text" v-model="companyForm.technologyStackText" placeholder="Java, Spring Boot, MySQL" />
          </label>

          <div v-for="(ip, index) in companyForm.intellectualProperties" :key="index" class="card">
            <div class="card__header">
              <span>知识产权 {{ index + 1 }}</span>
              <button type="button" class="link" @click="removeIntellectualProperty(index)" v-if="companyForm.intellectualProperties.length > 1">删除</button>
            </div>
            <label>类别
              <input type="text" v-model="ip.type" placeholder="专利 / 软著 / 商标" />
            </label>
            <label>编号
              <input type="text" v-model="ip.registrationNumber" />
            </label>
            <label>说明
              <textarea v-model="ip.description" rows="2"></textarea>
            </label>
          </div>
          <button type="button" class="button button--ghost" @click="addIntellectualProperty">+ 新增知识产权</button>

          <div class="form__files">
            <label>其他附件（可多选）
              <input type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" multiple @change="handleAttachmentUpload" />
            </label>
            <ul class="file-list">
              <li v-for="file in attachmentFiles" :key="file.id">{{ file.name }}</li>
            </ul>
          </div>

          <h3 class="form__section">四、联系人信息</h3>
          <div class="form__grid">
            <label>姓名
              <input type="text" v-model="companyForm.contact.name" />
            </label>
            <label>职务
              <input type="text" v-model="companyForm.contact.title" />
            </label>
            <label>电话
              <input type="text" v-model="companyForm.contact.phone" />
            </label>
            <label>工作邮箱
              <input type="email" v-model="companyForm.contact.workEmail" />
            </label>
          </div>

          <div class="form__actions">
            <button class="button" type="submit" :disabled="submitting">
              {{ submitting ? '提交中...' : '提交企业信息' }}
            </button>
            <span class="form__status" :class="{ 'form__status--error': submitError }">{{ submitMessage }}</span>
          </div>
        </form>
      </section>

      <section v-else class="panel">
        <header class="panel__header">
          <h2>企业匹配问答</h2>
          <p>向 ChatFlow 提问，快速定位最合适的企业及产品方案。</p>
          <div class="panel__hint">
            系统会把已提交企业的摘要拼成分隔的段落作为 ChatFlow 的 `context` 输入，便于模型理解背景。
          </div>
        </header>

        <form class="form form--compact" @submit.prevent="matchCompany">
          <label class="form__full">输入问题
            <textarea v-model="matchQuery" rows="4" placeholder="例如：寻找具备新能源电池管理系统经验的企业"></textarea>
          </label>
          <div class="form__actions">
            <button class="button" type="submit" :disabled="matching">
              {{ matching ? '匹配中...' : '开始匹配' }}
            </button>
            <span class="form__status" :class="{ 'form__status--error': !!matchError }">{{ matchError }}</span>
          </div>
        </form>

        <article v-if="matchResult" class="result">
          <h3>匹配结果</h3>
          <pre>{{ formattedMatchResult }}</pre>
        </article>
      </section>
    </main>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="./app.js"></script>
</body>
</html>
